# This file describes the serverless stack that serves as the back-end for the Litter Map application.
#
# Quick reference links:
#
# https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-specification-template-anatomy.html
# https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-specification-resources-and-properties.html
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-template-resource-type-ref.html
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/metadata-section-structure.html
# https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-specification-template-anatomy-globals.html
# https://theburningmonk.com/cloudformation-ref-and-getatt-cheatsheet/

AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: Global location submission and retrieval system

Globals:
  Function:
    Handler: index.handler
    Runtime: nodejs14.x
    CodeUri: functions

Resources:
  API:
    Type: AWS::Serverless::HttpApi
    Properties:
      Description: Backend API
      StageName: !Ref APIStageName
      Auth:
        Authorizers: {}

  CommonLib:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: lib-common
      ContentUri: lib/common
      CompatibleRuntimes:
        - nodejs14.x
      RetentionPolicy: Delete
    Metadata:
      BuildMethod: makefile

  PostgresLib:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: lib-postgres
      ContentUri: lib/postgres
      CompatibleRuntimes:
        - nodejs14.x
      RetentionPolicy: Delete
    Metadata:
      BuildMethod: makefile

  DefaultFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: default-response
      Description: Lets you know you've reached an invalid endpoint
      InlineCode: |-
        exports.handler = async () => {
          return {
            statusCode: 404,
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: "This endpoint does not exist. Please pick up that litter."
            })
          }
        }
      Events:
        Default:
          Type: HttpApi
          Properties:
            ApiId: !Ref API

  LogEventFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: log-event
      Description: Record a single event in the event log table
      Role: !GetAtt LogEventFunctionRole.Arn
      Environment:
        Variables:
          TABLE_NAME: !Ref EventsTable
    Metadata:
      BuildMethod: makefile

  AddLocationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: add-location
      Description: Add a location
      Role: !GetAtt AddLocationFunctionRole.Arn
      Layers:
        - !Ref CommonLib
        - !Ref PostgresLib
      Environment:
        Variables:
          SESSIONS_TABLE: !Ref SessionsTable
          SESSION_LIFETIME_IN_DAYS: !Ref SessionLifetimeInDays
          PGHOST: !GetAtt MainDB.Endpoint.Address
          PGPORT: !GetAtt MainDB.Endpoint.Port
          PGDATABASE: !Ref DBName
          PGUSER: writer
          PGPASSWORD: !Ref DBWriterPassword
          DB_GEOMETRY_TYPE_OID: !Ref DBGeometryTypeOID
          MEDIA_BUCKET: !Ref MediaBucket
          ALLOW_ANONYMOUS_SUBMIT: !Ref AllowAnonymousSubmit
      Events:
        AddLocation:
          Type: HttpApi
          Properties:
            ApiId: !Ref API
            Path: /add
            Method: POST
    Metadata:
      BuildMethod: makefile

  GetLocationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: get-location
      Description: Retrieve a location by its id
      Role: !GetAtt DBAccessFunctionRole.Arn
      Layers:
        - !Ref CommonLib
        - !Ref PostgresLib
      Environment:
        Variables:
          PGHOST: !GetAtt MainDB.Endpoint.Address
          PGPORT: !GetAtt MainDB.Endpoint.Port
          PGDATABASE: !Ref DBName
          PGUSER: reader
          PGPASSWORD: !Ref DBReaderPassword
          DB_GEOMETRY_TYPE_OID: !Ref DBGeometryTypeOID
      Events:
        GetLocationById:
          Type: HttpApi
          Properties:
            ApiId: !Ref API
            Path: /id/{id}
            Method: GET
        GetLocationsByRadius:
          Type: HttpApi
          Properties:
            ApiId: !Ref API
            Path: /radius
            Method: GET
    Metadata:
      BuildMethod: makefile

  InfoFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: info
      Description: Look up privileged information
      Role: !GetAtt InfoFunctionRole.Arn
      Layers:
        - !Ref CommonLib
      Environment:
        Variables:
          SESSIONS_TABLE: !Ref SessionsTable
          SESSION_LIFETIME_IN_DAYS: !Ref SessionLifetimeInDays
          USERS_TABLE: !Ref UsersTable
      Events:
        GetProfileInfo:
          Type: HttpApi
          Properties:
            ApiId: !Ref API
            Path: /profile
            Method: GET
    Metadata:
      BuildMethod: makefile

  LoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: login
      Description: Login proxy (redirects to third-party sign-in dialog)
      Role: !GetAtt LoginFunctionRole.Arn
      Layers:
        - !Ref CommonLib
      Environment:
        Variables:
          SESSIONS_TABLE: !Ref SessionsTable
          SESSION_LIFETIME_IN_DAYS: !Ref SessionLifetimeInDays
          CLIENTID_GOOGLE: !Ref GoogleClientId
      Events:
        Login:
          Type: HttpApi
          Properties:
            ApiId: !Ref API
            Path: /login/{service}
            Method: GET
            # RequestParameters:
            #   - method.request.path.service:
            #       Required: true
            #       Caching: false
        Logout:
          Type: HttpApi
          Properties:
            ApiId: !Ref API
            Path: /logout
            Method: GET
    Metadata:
      BuildMethod: makefile

  AuthFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: auth
      Description: Receive authorization from third-party sign-in dialog and start an authenticated user session
      Role: !GetAtt AuthFunctionRole.Arn
      Layers:
        - !Ref CommonLib
      Environment:
        Variables:
          SESSIONS_TABLE: !Ref SessionsTable
          SESSION_LIFETIME_IN_DAYS: !Ref SessionLifetimeInDays
          USERS_TABLE: !Ref UsersTable
          CLIENTID_GOOGLE: !Ref GoogleClientId
          CLIENTSECRET_GOOGLE: !Ref GoogleClientSecret
      Events:
        Authentication:
          Type: HttpApi
          Properties:
            ApiId: !Ref API
            Path: /auth/{service}
            Method: GET
    Metadata:
      BuildMethod: makefile

  GetUploadLinkFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: get-upload-link
      Description: Generate a signed upload link to the media bucket
      Role: !GetAtt GetUploadLinkFunctionRole.Arn
      Layers:
        - !Ref CommonLib
      Environment:
        Variables:
          SESSIONS_TABLE: !Ref SessionsTable
          SESSION_LIFETIME_IN_DAYS: !Ref SessionLifetimeInDays
          MEDIA_BUCKET: !Ref MediaBucket
          MAX_UPLOAD_FILE_SIZE: !Ref MaxUploadFileSize
      Events:
        GetUploadLink:
          Type: HttpApi
          Properties:
            ApiId: !Ref API
            Path: /getuploadlink
            Method: GET
    Metadata:
      BuildMethod: makefile

  DBInitFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: db-init
      Description: Administrative lambda that initilizes the littermap-db database
      Role: !GetAtt DBAccessFunctionRole.Arn
      Timeout: 10
      Layers:
        - !Ref PostgresLib
      Environment:
        Variables:
          PGHOST: !GetAtt MainDB.Endpoint.Address
          PGPORT: !GetAtt MainDB.Endpoint.Port
          PGDATABASE: !Ref DBName
          PGUSER: !Ref DBAdminUser
          PGPASSWORD: !Ref DBAdminPassword
          DB_WRITER_PASSWORD: !Ref DBWriterPassword
          DB_READER_PASSWORD: !Ref DBReaderPassword
    Metadata:
      BuildMethod: makefile

  DBRunFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: db-run
      Description: Runs a database query (as administrator)
      Role: !GetAtt DBAccessFunctionRole.Arn
      Layers:
        - !Ref PostgresLib
      Environment:
        Variables:
          PGHOST: !GetAtt MainDB.Endpoint.Address
          PGPORT: !GetAtt MainDB.Endpoint.Port
          PGDATABASE: !Ref DBName
          DB_ADMIN: !Ref DBAdminUser
          DB_ADMIN_PASSWORD: !Ref DBAdminPassword
          DB_WRITER_PASSWORD: !Ref DBWriterPassword
          DB_READER_PASSWORD: !Ref DBReaderPassword
    Metadata:
      BuildMethod: makefile

  AddLocationFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
               - lambda.amazonaws.com
            Action:
              - sts:AssumeRole

  InfoFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
               - lambda.amazonaws.com
            Action:
              - sts:AssumeRole

  LoginFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
               - lambda.amazonaws.com
            Action:
              - sts:AssumeRole

  AuthFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
               - lambda.amazonaws.com
            Action:
              - sts:AssumeRole

  GetUploadLinkFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
               - lambda.amazonaws.com
            Action:
              - sts:AssumeRole

  LogEventFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
               - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: eventlog-write
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Action: dynamodb:PutItem
                Resource: !GetAtt EventsTable.Arn
                Effect: Allow

  DBAccessFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
               - lambda.amazonaws.com
            Action:
              - sts:AssumeRole

  AllowDBAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: allow-rds-connect
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action: rds-db:connect
            Resource: !Sub arn:aws:rds:${AWS::Region}:${AWS::AccountId}:db:${MainDB}
            Effect: Allow
      Roles:
        - Ref: DBAccessFunctionRole
        - Ref: AddLocationFunctionRole

  AllowUsersAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: allow-users-access
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action:
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            Resource: !GetAtt UsersTable.Arn
            Effect: Allow
      Roles:
        - Ref: InfoFunctionRole
        - Ref: AuthFunctionRole

  AllowSessionsAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: allow-sessions-access
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action:
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            Resource: !GetAtt SessionsTable.Arn
            Effect: Allow
      Roles:
        - Ref: InfoFunctionRole
        - Ref: LoginFunctionRole
        - Ref: AuthFunctionRole
        - Ref: GetUploadLinkFunctionRole
        - Ref: AddLocationFunctionRole

  AllowLogEventPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: allow-log-event
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action: lambda:InvokeFunction
            Resource: !GetAtt LogEventFunction.Arn
            Effect: Allow
      Roles:
        - Ref: LoginFunctionRole
        - Ref: AuthFunctionRole
        - Ref: AddLocationFunctionRole

  AllowPutMediaPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: allow-put-media
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action:
              - s3:PutObject
              - s3:PutObjectAcl
            Resource: !Sub "arn:aws:s3:::${MediaBucket}/*"
            Effect: Allow
      Roles:
        - Ref: GetUploadLinkFunctionRole

  AllowTagMediaPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: allow-tag-media
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action:
              - s3:PutObjectTagging
            Resource: !Sub "arn:aws:s3:::${MediaBucket}/*"
            Effect: Allow
      Roles:
        - Ref: GetUploadLinkFunctionRole
        - Ref: AddLocationFunctionRole

  # Main database that stores the world
  MainDB:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Ref DBName
      DBSnapshotIdentifier: !If [HasDBSnapshotIdentifier, !Ref DBSnapshotIdentifier, !Ref 'AWS::NoValue']
      DBName: !Ref DBName
      Engine: postgres
      EngineVersion: !Ref DBPostgresVersion
      AllowMajorVersionUpgrade: true
      AutoMinorVersionUpgrade: true
      DBInstanceClass: !Ref DBInstanceClass
      AllocatedStorage: !Ref DBAllocatedStorage
      BackupRetentionPeriod: 0 # no automated backups
      MasterUsername: !Ref DBAdminUser
      MasterUserPassword: !Ref DBAdminPassword

  # Users
  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: users
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: !Ref UsersTableReadCapacity
        WriteCapacityUnits: !Ref UsersTableWriteCapacity

  # Sessions
  SessionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: sessions
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: expires_at
        Enabled: true
      ProvisionedThroughput:
        ReadCapacityUnits: !Ref SessionsTableReadCapacity
        WriteCapacityUnits: !Ref SessionsTableWriteCapacity

  # Event log
  EventsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: event-log
      AttributeDefinitions:
        - AttributeName: date_key
          AttributeType: S
        - AttributeName: time_key
          AttributeType: S
      KeySchema:
        - AttributeName: date_key
          KeyType: HASH
        - AttributeName: time_key
          KeyType: RANGE
      ProvisionedThroughput:
        ReadCapacityUnits: !Ref EventLogReadCapacity
        WriteCapacityUnits: !Ref EventLogWriteCapacity

  MediaBucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: Private
      LifecycleConfiguration:
        Rules:
          - Id: DeleteUnverified
            ExpirationInDays: 1
            Status: Enabled
            TagFilters:
              - Key: verified
                Value: false
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - "*"
            AllowedMethods:
              - GET
              - POST
              - HEAD
            AllowedOrigins:
              - "*" # In production, should be domain name

  WebsiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: Private
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: index.html # Single-page application handles routing on the front-end

  WebsiteDelivery:
    Type: AWS::CloudFront::Distribution
    DependsOn:
      - MediaBucket
      - WebsiteBucket
    Properties:
      DistributionConfig:
        Enabled: !If [HasCDN, true, false]
        Origins:
          - Id: BackendAPI
            DomainName: !Sub ${API}.execute-api.${AWS::Region}.${AWS::URLSuffix}
            CustomOriginConfig:
              HTTPSPort: 443
              OriginProtocolPolicy: https-only
          - Id: Media
            DomainName: !GetAtt MediaBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: "" # Specify this to restrict direct access to the S3 bucket
            ConnectionAttempts: 2
            ConnectionTimeout: 2
          - Id: FrontendApplication
            DomainName: !Sub ${WebsiteBucket}.s3-website-${AWS::Region}.amazonaws.com
            CustomOriginConfig:
              OriginProtocolPolicy: http-only # S3 "website" origin only supports HTTP
            ConnectionAttempts: 1
            ConnectionTimeout: 2
        CacheBehaviors:
          - PathPattern: !Sub ${APIStageName}/*
            TargetOriginId: BackendAPI
            AllowedMethods:
              - GET
              - HEAD
              - POST
              - PUT
              - DELETE
              - PATCH
              - OPTIONS
            ForwardedValues:
              Headers:
                # Specify headers that the back-end API needs to receive
                - Referer
              QueryString: true
              Cookies:
                Forward: all
            MaxTTL: 0
            MinTTL: 0
            DefaultTTL: 0
            Compress: true
            ViewerProtocolPolicy: redirect-to-https
          - PathPattern: media/*
            TargetOriginId: Media
            AllowedMethods:
              - GET
              - HEAD
            ForwardedValues:
              QueryString: false
              Cookies:
                Forward: none
            Compress: true
            ViewerProtocolPolicy: redirect-to-https
        DefaultCacheBehavior:
          TargetOriginId: FrontendApplication
          AllowedMethods:
            - GET
            - HEAD
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
          Compress: true
          ViewerProtocolPolicy: redirect-to-https
        DefaultRootObject: index.html
        HttpVersion: http2
        IPV6Enabled: true
        ViewerCertificate:
          CloudFrontDefaultCertificate: true

Parameters:
  APIStageName:
    Description: API stage
    Type: String
    Default: api
  DBInstanceClass:
    Description: Database instance class
    Type: String
    Default: db.t2.micro
  DBPostgresVersion:
    Description: PostgreSQL version
    Type: String
    Default: 12.7
  DBAllocatedStorage:
    Description: Allocated storage (in GB)
    Type: Number
    Default: 5
  DBSnapshotIdentifier:
    Description: Provide the database snapshot id if you don't want a new database
    Type: String
  DBName:
    Description: Database name
    Type: String
    AllowedPattern: "[a-zA-Z][a-zA-Z0-9]*"
    ConstraintDescription: Must begin with a letter and contain only alphanumeric characters
    Default: littermap
  DBAdminUser:
    Description: Database admin username
    Type: String
    AllowedPattern: "[a-zA-Z][a-zA-Z0-9]*"
    ConstraintDescription: Must begin with a letter and contain only alphanumeric characters
    Default: litteradmin
  DBAdminPassword:
    Description: Database admin password
    Type: String
    MinLength: 8
    MaxLength: 128
    AllowedPattern: "[^\\s@\"\\/]*"
    ConstraintDescription: 'The password must be 8 to 128 characters and can include any printable ASCII character except "/", """, or "@"'
    Default: pristine
  DBWriterPassword:
    Description: Database write access password
    Type: String
    MinLength: 8
    MaxLength: 128
    AllowedPattern: "[^\\s@\"\\/]*"
    ConstraintDescription: 'The password must be 8 to 128 characters and can include any printable ASCII character except "/", """, or "@"'
    Default: recorder
  DBReaderPassword:
    Description: Database reader access password
    Type: String
    MinLength: 8
    MaxLength: 128
    AllowedPattern: "[^\\s@\"\\/]*"
    ConstraintDescription: 'The password must be 8 to 128 characters and can include any printable ASCII character except "/", """, or "@"'
    Default: observer
  DBGeometryTypeOID:
    Description: Geometry type OID once PostGIS extension is set up
    Type: Number
    Default: -1
  GoogleClientId:
    Description: Client ID issued by Google for third-party sign-in authentication
    Type: String
  GoogleClientSecret:
    Description: Client secret issued by Google for third-party sign-in authentication
    Type: String
  UsersTableReadCapacity:
    Description: Users table provisioned read capacity
    Type: Number
    Default: 1
  UsersTableWriteCapacity:
    Description: Users table provisioned write capacity
    Type: Number
    Default: 1
  SessionLifetimeInDays:
    Description: How many days will browser sessions expire after they were created
    Type: Number
    Default: 3
  SessionsTableReadCapacity:
    Description: Session table provisioned read capacity
    Type: Number
    Default: 1
  SessionsTableWriteCapacity:
    Description: Session table provisioned write capacity
    Type: Number
    Default: 1
  EventLogReadCapacity:
    Description: Event log table provisioned read capacity
    Type: Number
    Default: 1
  EventLogWriteCapacity:
    Description: Event log table provisioned write capacity
    Type: Number
    Default: 1
  AllowAnonymousSubmit:
    Description: Allow users who are not logged in to submit a location
    Type: Number
    AllowedValues:
      - 0
      - 1
    Default: 0
  MaxUploadFileSize:
    Description: Maximum allowed upload size
    Type: Number
    Default: 12582910
  EnableCDN:
    Description: Enable global delivery with CloudFront
    Type: Number
    AllowedValues:
      - 0
      - 1
    Default: 1

Conditions:
  HasNotDBSnapshotIdentifier: !Equals [!Ref DBSnapshotIdentifier, '']
  HasDBSnapshotIdentifier: !Not [!Condition HasNotDBSnapshotIdentifier]
  HasCDN: !Equals [!Ref EnableCDN, 1]

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      -
        Label:
          default: Main database
        Parameters:
          - DBName
          - DBInstanceClass
          - DBPostgresVersion
          - DBAllocatedStorage
          - DBSnapshotIdentifier
          - DBAdminUser
          - DBAdminPassword
          - DBWriterPassword
          - DBReaderPassword
          - DBGeometryTypeOID
      -
        Label:
          default: User accounts
        Parameters:
          - UsersTableReadCapacity
          - UsersTableWriteCapacity
      -
        Label:
          default: Browsing sessions
        Parameters:
          - SessionLifetimeInDays
          - SessionsTableReadCapacity
          - SessionsTableWriteCapacity
      -
        Label:
          default: Authentication
        Parameters:
          - GoogleClientId
          - GoogleClientSecret
      -
        Label:
          default: Event log
        Parameters:
          - EventLogReadCapacity
          - EventLogWriteCapacity
      -
        Label:
          default: User permissions
        Parameters:
          - AllowAnonymousSubmit
      -
        Label:
          default: User uploads
        Parameters:
          - MaxUploadFileSize
      -
        Label:
          default: Backend API
        Parameters:
          - APIStageName

Outputs:
  MainDBHost:
    Description: Database remote host
    Value: !Sub "postgresql://${MainDB.Endpoint.Address}:${MainDB.Endpoint.Port}/${DBName}"
  MediaBucket:
    Description: S3 bucket that stores media content uploaded by users
    Value: !Sub "https://${MediaBucket.DomainName}"
  API:
    Description: Backend API
    Value: !Sub "https://${API}.execute-api.${AWS::Region}.${AWS::URLSuffix}/${API.Stage}/"
  WebsiteFiles:
    Description: Website Assets
    Value: !Sub "${WebsiteBucket.WebsiteURL}"
  Website:
    Description: Website (delivered by CDN)
    Value: !If [HasCDN, !Sub "https://${WebsiteDelivery.DomainName}", "Not enabled"]
  ManagementConsole:
    Description: Manage this application
    Value: !Sub "https://console.aws.amazon.com/lambda/home?region=${AWS::Region}#/applications/${AWS::StackName}"
